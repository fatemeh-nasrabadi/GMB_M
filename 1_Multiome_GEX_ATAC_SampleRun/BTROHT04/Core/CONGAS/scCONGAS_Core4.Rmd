---
title: "scCONGAS_Core4"
output: html_document
date: "2024-12-12"
---

```{r}
reticulate::use_condaenv("CONGAS", required = TRUE)
library(reticulate)
# devtools::load_all("~/work/r_packages/rcongas/")
```

```{r}
library(Rcongas)
library(dplyr)
library(ggplot2)
library(stringr)

#data(multiome_congas_object) 

#filt = segments_selector_congas(multiome_congas_object)
# You can save the filtering result to avoid re-running the whole pipeline in future steps
# saveRDS(filt, paste0(out.dir, "rcongas_obj_filtered.rds"))
```

```{r}
library(Seurat)
```

```{r}
#read multiome data
multi <- Read10X("/group/sottoriva/00-PROCESSED_DATA/2023-ROVIGO/pre_demultiplexing/BTHROHT01_BTHROHT02_BTHROHT04/multiome/LAZ_315/filtered_feature_bc_matrix")
myrna_counts <- multi$`Gene Expression`
myatac_counts <- multi$`Peaks`
myatac_counts

# Replace ":" with "-" in the row names of the matrix
rownames(myatac_counts) <- gsub(":", "-", rownames(myatac_counts))

# Verify the result
head(rownames(myatac_counts))

typeof(multi)
myrna_counts
myatac_counts

```

```{r}
#/group/sottoriva/00-PROCESSED_DATA/2023-ROVIGO/BTROHT01/BTROHT01/BTROHT01_T1_T7_T9/multiome/LAZ_160/filtered_feature_bc_matrix.h5
mybarcode_list <- read.table("/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT04/Core/CONGAS/BTROHT04_core_barcodes_all.tsv", sep="\t", header=TRUE)
mybarcode_list
mybarcode_values <- mybarcode_list$X


myrna_counts <- myrna_counts[, colnames(myrna_counts) %in% mybarcode_values]
myatac_counts <- myatac_counts[, colnames(myatac_counts) %in% mybarcode_values]
myatac_counts
myrna_counts
#myatac
#
```

```{r}
library(data.table)
# Read the gzipped TSV file
myfeatures <- fread("gunzip -c /group/sottoriva/00-PROCESSED_DATA/2023-ROVIGO/pre_demultiplexing/BTHROHT01_BTHROHT02_BTHROHT04/multiome/LAZ_315/filtered_feature_bc_matrix/features.tsv.gz")
new_names <- c("gene_id", "gene", "modality", "chr", "from", "to")
names(myfeatures) <- new_names
tail(myfeatures)
```

```{r}
#getwd()
#sample = "/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT01/Perimarginal"

#prefix = paste0(sample, "/CONGAS/")

#out.dir = paste0(prefix, "/congas_data/")
#fig.dir = paste0(prefix, "/congas_figures/")

#if (!dir.exists(out.dir)) {dir.create(out.dir, recursive = T)}
#if (!dir.exists(fig.dir)) {dir.create(fig.dir, recursive = T)}

```

```{r}
myatac_featureDF = data.frame(id = rownames(myatac_counts)) %>%
  tidyr::separate(id, c('chr', 'from', 'to'), '-')
myatac_featureDF

myfeatures
```

```{r}
myatac = Rcongas::create_congas_tibble(counts = myatac_counts, 
                                     modality = 'ATAC', 
                                     save_dir = NULL,
                                     features = myatac_featureDF)
myatac <- na.omit(myatac)



#mybarcode_list
#mybarcode_values <- mybarcode_list$X

```

```{r}
library(dplyr)

# Step 1: Filter Barcodes in `barcode_list` that match `myatac$cell`
filtered_barcodes <- mybarcode_list %>%
  filter(X %in% myatac$cell)
filtered_barcodes

# Step 2: Generate Metadata with "-ATAC"
metadata_atac <- filtered_barcodes %>%
  mutate(cell = paste0(X, "-ATAC"), type = celltype) %>%
  select(cell, type)

# Step 3: Generate Metadata with "-RNA"
metadata_rna <- filtered_barcodes %>%
  mutate(cell = paste0(X, "-RNA"), type = celltype) %>%
  select(cell, type)

# Step 4: Combine ATAC and RNA Metadata
mymetadata <- bind_rows(metadata_atac, metadata_rna)

# Step 5: View Summary
print(mymetadata)
tail(mymetadata)
# Optional: Save to a file if needed
# write.csv(metadata, "metadata.csv", row.names = FALSE)

mymetadata
```

```{r}
# Compute normalization factors
mynorm_atac = Rcongas:::auto_normalisation_factor(myatac) %>%
  mutate(modality = 'ATAC')

myrna = Rcongas::create_congas_tibble(counts = myrna_counts, 
                                    modality = 'RNA', 
                                    save_dir=NULL, 
                                    features = features)

# Compute normalization factors
mynorm_rna = Rcongas:::auto_normalisation_factor(myrna) %>%
  mutate(modality = 'RNA')

myatac = myatac %>% mutate(value = as.integer(value))
myrna = myrna %>% mutate(value = as.integer(value))
```

```{r}
myrna = myrna %>% filter_known_genes(what='r')
all_genes = myrna$gene %>% unique
mito = all_genes %>% str_starts(pattern = 'MT-')
all_genes = setdiff(all_genes, all_genes[mito])
myrna = myrna %>% dplyr::filter(gene %in% all_genes)
```

```{r}
mysegs <- read.csv("/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT04/Core/CONGAS/BTROHT04_copre_segs_for_congas.csv", sep = "\t", row.names = 1)
mysegs
mysegments = mysegs %>% dplyr::filter(chr != 'chrX', chr != 'chrY')

```


```{r}
# Inspect cell IDs
#head(rownames(myrna))
#head(rownames(mynorm_rna))
#head(rownames(myatac))
#head(rownames(mynorm_atac))


# Check for missing normalization factors in RNA
#missing_rna <- setdiff(rownames(myrna), rownames(norm_rna))
#missing_rna

# Check for missing normalization factors in ATAC
#missing_atac <- setdiff(rownames(myatac), rownames(norm_atac))
#missing_atac

```

```{r}

myx = init(
  rna = myrna,
  atac = myatac,
  segmentation = mysegments, #%>% mutate(copies = as.integer(round(copies))),
  rna_normalisation_factors = mynorm_rna,
  atac_normalisation_factors = mynorm_atac,
  rna_likelihood = "NB", 
  atac_likelihood = "NB",
  description = paste0('Bimodal', "sample"),
  multiome = TRUE)

```

```{r}

# Load necessary libraries
library(dplyr)

# Define the output file path
output_file <- "plot1.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed


#plot the number of nonzero cells vs the number of peaks per segment,
ggplot(myx$input$segmentation, aes(x=ATAC_nonzerocells, y=ATAC_peaks)) + geom_point() + theme_bw()
# Close the PDF device
dev.off()

# Print a message to confirm
cat("Plot saved to:", output_file)

```

```{r}

# Load necessary libraries
library(dplyr)

# Define the output file path
output_file <- "plot2.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed


ggplot(myx$input$segmentation, aes(x=RNA_nonzerocells, y=RNA_genes)) + geom_point() + theme_bw()
# Close the PDF device
dev.off()

# Print a message to confirm
cat("Plot saved to:", output_file)


```

```{r}
myx = Rcongas::filter_segments(myx, RNA_nonzerocells = 300, ATAC_nonzerocells = 300)
```


```{r}

# Load necessary libraries
library(dplyr)

# Define the output file path
output_file <- "countdistribution_RNA_ATAC.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed


plot_data(
  myx,
  what = 'histogram',
  segments = get_input(myx, what = 'segmentation') %>%
    ungroup() %>%
    mutate(L = to - from) %>%
    dplyr::arrange(dplyr::desc(L)) %>%
    dplyr::top_n(30) %>%
    pull(segment_id)
)

# Close the PDF device
dev.off()

# Print a message to confirm
cat("Plot saved to:", output_file)

```



```{r}
getwd()
myx$input$metadata = mymetadata
mymetadata
# Load necessary libraries
library(dplyr)

# Define the output file path
output_file <- "countdistribution_annotated.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

# Plot the data
plot_data(
  myx, 
  to_plot = 'type', 
  position = 'stack',
  segments = get_input(myx, what = 'segmentation') %>%
    ungroup() %>%
    mutate(L = to - from) %>%
    arrange(desc(L)) %>%
    top_n(30) %>%
    pull(segment_id)
)

# Close the PDF device
dev.off()

# Print a message to confirm
cat("Plot saved to:", output_file)

typeof(myx)

str(myx)
lapply(myx$input, class)
myx$input$segmentation
myx$input$segmentation <- as.data.frame(myx$input$segmentation)


```



```{r}
#fitting a model 
myx

library(Rcongas)
library(dplyr)
library(ggplot2)
library(stringr) 


filt = segments_selector_congas(myx)
# You can save the filtering result to avoid re-running the whole pipeline in future steps
# saveRDS(filt, paste0(out.dir, "rcongas_obj_filtered.rds"))

```


```{r}


# Set values fro the model hyperparameters
k = c(1:4)

binom_limits = c(40,1000)
model = "BIC"

lr = 0.01
temperature = 20

steps = 5000
lambda = 0.5

# Estimate hyperparameters
hyperparams_filt <- auto_config_run(filt, k, 
                                    prior_cn=c(0.2, 0.6, 0.1, 0.05, 0.05),
                                    init_importance = 0.6, 
                                    CUDA = FALSE, 
                                    normal_cells=TRUE)

# Run
hyperparams_filt$binom_prior_limits = binom_limits

fit_filt <- Rcongas:::fit_congas(filt,
                                 K = k, 
                                 lambdas = lambda, 
                                 learning_rate = lr, 
                                 steps = steps,
                                 model_parameters = hyperparams_filt, 
                                 model_selection = model,
                                 latent_variables = "G",
                                 CUDA = FALSE,
                                 temperature = temperature, 
                                 same_mixing = TRUE, 
                                 threshold = 0.001)

```

```{r}
# Define the output file path
output_file <- "CONGAS_heatmap_annotated.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

plot_fit(fit_filt, what = 'heatmap',scale = TRUE , scale_min_lim = -2, scale_max_lim = 2)

dev.off()

```

```{r}
# Define the output file path
output_file <- "CONGAS_clusters.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed
plot_fit(fit_filt, 'posterior_CNA')
dev.off()

```

```{r}
# Define the output file path
output_file <- "scores_fitplot.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

Rcongas::plot_fit(fit_filt, what='scores')

dev.off()


```


```{r}

# Define the output file path
output_file <- "fitplot.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

Rcongas::plot_fit(fit_filt, what='scores')

dev.off()

```


```{r}

# Define the output file path
output_file <- "density_fitplot.pdf"

# Open a PDF device
pdf(file = output_file, width = 20, height = 16)  # Adjust width and height as needed

p = cowplot::plot_grid( 
  plotlist = plot_fit(fit_filt, what = 'density', highlights = TRUE),
  ncol = 4)
p
dev.off()


```
```{r}
fit_filt$best_fit$cluster_assignments
getwd()
write.csv(fit_filt$best_fit$cluster_assignments, file = "/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT04/Core/CONGAS/BTROHT04_CONGAS_Clusters.csv", row.names = FALSE)
```

```{r}
getwd()
saveRDS(fit_filt, "/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT04/Core/CONGAS/rcongas_obj_filtered_BTROHT04_core_all_cells.rds")
```


```{r}
df <- data.frame(fit_filt$best_fit$CNA_real$cluster, fit_filt$best_fit$CNA_real$value, fit_filt$best_fit$CNA_real$segment_id)
df

write.table(df, file = "/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT04/Core/CONGAS/ploidy_by_segments_BTROHT04_core.tsv", sep = "\t", row.names = FALSE, quote = FALSE)
```

```{r}

# Define the output file path
output_file <- "CONGAS_cluster.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

plot_fit(fit_filt, 'posterior_CNA')

dev.off()

```

```{r}
library(Rcongas)
library(dplyr)
library(ggplot2)
library(stringr)
```

```{r}

filt = segments_selector_congas(myx)
# You can save the filtering result to avoid re-running the whole pipeline in future steps
# saveRDS(filt, paste0(out.dir, "rcongas_obj_filtered.rds"))
```

```{r}
filt = segments_selector_congas(myx)
```

```{r}

# Set values fro the model hyperparameters
k = c(1:4)

binom_limits = c(40,1000)
model = "BIC"

lr = 0.01
temperature = 20

steps = 5000
lambda = 0.5

# Estimate hyperparameters
hyperparams_filt <- auto_config_run(filt, k, 
                                    prior_cn=c(0.2, 0.6, 0.1, 0.05, 0.05),
                                    init_importance = 0.6, 
                                    CUDA = FALSE, 
                                    normal_cells=TRUE)

# Run
hyperparams_filt$binom_prior_limits = binom_limits

fit_filt <- Rcongas:::fit_congas(filt,
                                 K = k, 
                                 lambdas = lambda, 
                                 learning_rate = lr, 
                                 steps = steps,
                                 model_parameters = hyperparams_filt, 
                                 model_selection = model,
                                 latent_variables = "G",
                                 CUDA = FALSE,
                                 temperature = temperature, 
                                 same_mixing = TRUE, 
                                 threshold = 0.001)


```


```{r}
fit_filt$model_selection

```

```{r}

# Define the output file path
output_file <- "fitplot.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

Rcongas::plot_fit(fit_filt, what='scores')

dev.off()

```


```{r}

# Define the output file path
output_file <- "CONGAS_cluster.pdf"

# Open a PDF device
pdf(file = output_file, width = 12, height = 8)  # Adjust width and height as needed

plot_fit(fit_filt, 'posterior_CNA')

dev.off()

```

```{r}
plot_fit(fit_filt, what = 'heatmap',scale = TRUE , scale_min_lim = -2, scale_max_lim = 2)

```

```{r}
write.csv(fit_filt$best_fit$cluster_assignments, file = "/scratch/alexandra.livanova/ROVIGO/multiome/BTROHT_01_02_04/BTROHT01_clusters_resulted.csv", row.names = FALSE)
```

```{r eval=FALSE, include=FALSE}
library(reticulate)
library(Rcongas)
library(dplyr)
library(ggplot2)
library(stringr)
library(data.table)
library(Seurat)

# Set Conda environment
reticulate::use_condaenv("CONGAS", required = TRUE)

# Read multiome data
multi_tumor <- Read10X("/group/sottoriva/00-PROCESSED_DATA/2023-ROVIGO/BTROHT01/BTROHT01/BTROHT01_T1_T7_T9/multiome/LAZ_160/filtered_feature_bc_matrix")
myrna_counts_tumor <- multi_tumor$`Gene Expression`
myatac_counts_tumor <- multi_tumor$`Peaks`
rownames(myatac_counts_tumor) <- gsub(":", "-", rownames(myatac_counts_tumor))

# Read barcode list
mybarcode_list_tumor <- read.table("/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT01/Perimarginal/CONGAS/BTROHT01_peri_barcodes_all.tsv", sep="\t", header=TRUE)
mybarcode_values_tumor <- mybarcode_list_tumor$X
myrna_counts_tumor <- myrna_counts_tumor[, colnames(myrna_counts_tumor) %in% mybarcode_values_tumor]
myatac_counts_tumor <- myatac_counts_tumor[, colnames(myatac_counts_tumor) %in% mybarcode_values_tumor]

# Read features
myfeatures_tumor <- fread("gunzip -c /group/sottoriva/00-PROCESSED_DATA/2023-ROVIGO/BTROHT01/BTROHT01/BTROHT01_T1_T7_T9/multiome/LAZ_160/filtered_feature_bc_matrix/features.tsv.gz")
names(myfeatures_tumor) <- c("gene_id", "gene", "modality", "chr", "from", "to")

# Process ATAC features
myatac_featureDF_tumor <- data.frame(id = rownames(myatac_counts_tumor)) %>%
  tidyr::separate(id, c('chr', 'from', 'to'), '-')

# Create ATAC tibble
myatac_tumor <- Rcongas::create_congas_tibble(
  counts = myatac_counts_tumor, 
  modality = 'ATAC', 
  save_dir = NULL,
  features = myatac_featureDF_tumor
) %>% na.omit()

# Generate metadata
filtered_barcodes_tumor <- mybarcode_list_tumor %>%
  filter(X %in% myatac_tumor$cell)
metadata_atac_tumor <- filtered_barcodes_tumor %>%
  mutate(cell = paste0(X, "-ATAC"), type = celltype) %>%
  select(cell, type)
metadata_rna_tumor <- filtered_barcodes_tumor %>%
  mutate(cell = paste0(X, "-RNA"), type = celltype) %>%
  select(cell, type)
mymetadata_tumor <- bind_rows(metadata_atac_tumor, metadata_rna_tumor)

# Normalize data
mynorm_atac_tumor <- Rcongas:::auto_normalisation_factor(myatac_tumor) %>%
  mutate(modality = 'ATAC')
myrna_tumor <- Rcongas::create_congas_tibble(
  counts = myrna_counts_tumor, 
  modality = 'RNA', 
  save_dir = NULL, 
  features = myfeatures_tumor
)
mynorm_rna_tumor <- Rcongas:::auto_normalisation_factor(myrna_tumor) %>%
  mutate(modality = 'RNA')
myatac_tumor <- myatac_tumor %>% mutate(value = as.integer(value))
myrna_tumor <- myrna_tumor %>% mutate(value = as.integer(value))

# Filter RNA data
myrna_tumor <- myrna_tumor %>% filter_known_genes(what = 'r')
all_genes_tumor <- myrna_tumor$gene %>% unique
mito_tumor <- all_genes_tumor %>% str_starts(pattern = 'MT-')
all_genes_tumor <- setdiff(all_genes_tumor, all_genes_tumor[mito_tumor])
myrna_tumor <- myrna_tumor %>% dplyr::filter(gene %in% all_genes_tumor)

# Process segments
mysegs_tumor <- read.csv("/home/fatemeh.nasrabadi/ROVIGO_congas/BTROHT01/Core/CONGAS/BTROHT01_copre_segs_for_congas.csv", sep = "\t", row.names = 1)
mysegments_tumor <- mysegs_tumor %>% dplyr::filter(chr != 'chrX', chr != 'chrY')

# Initialize Rcongas object
myx_tumor <- init(
  rna = myrna_tumor,
  atac = myatac_tumor,
  segmentation = mysegments_tumor,
  rna_normalisation_factors = mynorm_rna_tumor,
  atac_normalisation_factors = mynorm_atac_tumor,
  rna_likelihood = "NB", 
  atac_likelihood = "NB",
  description = 'Bimodal ','sample',
  multiome = TRUE
)

# Generate and save plots
pdf(file = "plot1_tumor.pdf", width = 12, height = 8)
ggplot(myx_tumor$input$segmentation, aes(x = ATAC_nonzerocells, y = ATAC_peaks)) + geom_point() + theme_bw()
dev.off()
pdf(file = "plot2_tumor.pdf", width = 12, height = 8)
ggplot(myx_tumor$input$segmentation, aes(x = RNA_nonzerocells, y = RNA_genes)) + geom_point() + theme_bw()
dev.off()

# Filter segments and plot count distributions
myx_tumor <- Rcongas::filter_segments(myx_tumor, RNA_nonzerocells = 300, ATAC_nonzerocells = 300)
pdf(file = "countdistribution_RNA_ATAC_tumor.pdf", width = 12, height = 8)
plot_data(
  myx_tumor,
  what = 'histogram',
  segments = get_input(myx_tumor, what = 'segmentation') %>%
    ungroup() %>%
    mutate(L = to - from) %>%
    dplyr::arrange(dplyr::desc(L)) %>%
    dplyr::top_n(30) %>%
    pull(segment_id)
)
dev.off()
pdf(file = "countdistribution_annotated_tumor.pdf", width = 12, height = 8)
plot_data(
  myx_tumor, 
  to_plot = 'type', 
  position = 'stack',
  segments = get_input(myx_tumor, what = 'segmentation') %>%
    ungroup() %>%
    mutate(L = to - from) %>%
    arrange(desc(L)) %>%
    top_n(30) %>%
    pull(segment_id)
)
dev.off()

# Check for missing values
colSums(is.na(myatac_tumor[, c("chr", "from", "to")]))



```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.















```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
